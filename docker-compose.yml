version: '3.9'

services:
  mcp:
    image: ghcr.io/trek-boldly-go/actual-budget-mcp-server:latest
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      - keycloak
    platform: ${MCP_DOCKER_PLATFORM:-linux/amd64}
    environment:
      MCP_PORT: ${MCP_PORT:-3000}
      MCP_AUTH_MODE: ${MCP_AUTH_MODE:-oauth}
      MCP_PUBLIC_URL: ${MCP_PUBLIC_URL:-http://localhost:3000/mcp}
      MCP_OAUTH_ISSUER_URL: ${MCP_OAUTH_ISSUER_URL:-http://keycloak:8080/realms/actual-mcp}
      MCP_OAUTH_CLIENT_ID: ${KEYCLOAK_INTROSPECTION_CLIENT_ID:-actual-mcp-introspection}
      MCP_OAUTH_CLIENT_SECRET: ${KEYCLOAK_INTROSPECTION_CLIENT_SECRET:-actual-mcp-introspection-secret}
      MCP_OAUTH_AUDIENCE: ${MCP_OAUTH_AUDIENCE:-}
      MCP_DANGEROUSLY_ALLOW_INSECURE_ISSUER_URL: ${MCP_DANGEROUSLY_ALLOW_INSECURE_ISSUER_URL:-true}
      # Actual configuration (replace with your values)
      ACTUAL_SERVER_URL: ${ACTUAL_SERVER_URL:-https://your-actual-server}
      ACTUAL_PASSWORD: ${ACTUAL_PASSWORD:-changeme}
      ACTUAL_SYNC_ID: ${ACTUAL_SYNC_ID:-changeme}
    ports:
      - '${MCP_PORT:-3000}:3000'

  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    command: start-dev --http-port=8080 --hostname-strict=false --import-realm
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
    depends_on:
      - keycloak-realm-builder
    volumes:
      - keycloak-import:/opt/keycloak/data/import
    ports:
      - '8080:8080'

  keycloak-realm-builder:
    image: alpine:3
    entrypoint: /bin/sh
    command: -c "apk add --no-cache gettext >/dev/null && mkdir -p /opt/keycloak/data/import && envsubst < /template/realm-template.json > /opt/keycloak/data/import/actual-mcp-realm.json"
    environment:
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-actual-mcp}
      KEYCLOAK_PUBLIC_CLIENT_ID: ${KEYCLOAK_PUBLIC_CLIENT_ID:-actual-mcp-public}
      KEYCLOAK_INTROSPECTION_CLIENT_ID: ${KEYCLOAK_INTROSPECTION_CLIENT_ID:-actual-mcp-introspection}
      KEYCLOAK_INTROSPECTION_CLIENT_SECRET: ${KEYCLOAK_INTROSPECTION_CLIENT_SECRET:-actual-mcp-introspection-secret}
      KEYCLOAK_DEMO_USER: ${KEYCLOAK_DEMO_USER:-demo-user}
      KEYCLOAK_DEMO_PASSWORD: ${KEYCLOAK_DEMO_PASSWORD:-demo-pass}
      KEYCLOAK_DEMO_FIRST_NAME: ${KEYCLOAK_DEMO_FIRST_NAME:-Demo}
      KEYCLOAK_DEMO_LAST_NAME: ${KEYCLOAK_DEMO_LAST_NAME:-User}
      MCP_PUBLIC_URL_BASE: ${MCP_PUBLIC_URL_BASE:-http://localhost:3000}
    volumes:
      - keycloak-import:/opt/keycloak/data/import
      - ./docker/keycloak/realm-export/actual-mcp-realm.template.json:/template/realm-template.json:ro

volumes:
  keycloak-import:
